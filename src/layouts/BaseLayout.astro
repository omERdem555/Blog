---
import "../styles/global.css";
import { SITE } from "../config/site";
import { getTaxonomy } from "../lib/taxonomy";

const { categories, tags } = await getTaxonomy();

interface Props {
  title?: string;
  description?: string;
  image?: string;
  type?: "website" | "article";
  publishedTime?: string;
  modifiedTime?: string;
}

const {
  title,
  description,
  image,
  type = "website",
  publishedTime,
  modifiedTime,
} = Astro.props;

const pageTitle = title
  ? `${title} | ${SITE.title}`
  : SITE.title;

const pageDescription = description || SITE.description;

const canonicalURL = new URL(Astro.url.pathname, SITE.url).toString();

const ogImage = image
  ? new URL(image, SITE.url).toString()
  : `${SITE.url}/og-default.png`;

const structuredData =
  type === "article"
    ? {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        headline: pageTitle,
        description: pageDescription,
        image: ogImage,
        author: {
          "@type": "Person",
          name: SITE.author,
        },
        datePublished: publishedTime,
        dateModified: modifiedTime || publishedTime,
        mainEntityOfPage: canonicalURL,
      }
    : {
        "@context": "https://schema.org",
        "@type": "WebSite",
        name: SITE.title,
        url: SITE.url,
      };
---
<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="index, follow" />

    <script>
      if (localStorage.getItem("theme") === "dark") {
        document.documentElement.classList.add("dark");
      }
    </script>

    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={canonicalURL} />
    <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="/rss.xml" />

    <!-- SVG Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <meta name="theme-color" content="#ffffff" />

    <!-- Open Graph -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content={SITE.title} />
    <meta property="og:locale" content={SITE.locale} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImage} />
    <meta name="twitter:creator" content={SITE.twitter} />

    <script type="application/ld+json">
      {JSON.stringify(structuredData)}
    </script>
  </head>

  <body>
    <div class="page-wrapper">

      <header class="site-header">
        <div class="header-inner">
          <a href="/" class="logo">Blog | Ömer'in Blogu</a>

          <button class="mobile-toggle" id="mobile-toggle">
            ☰
          </button>

          <nav class="nav-right" id="nav-menu">

            <a href="/" class="nav-link">Blog</a>

            <div class="dropdown">
              <button class="dropdown-toggle">Kategori</button>
              <div class="dropdown-menu">
                {categories.map(cat => (
                  <a href={`/categories/${cat.name}/`} class="dropdown-item">
                    {cat.name} ({cat.count})
                  </a>
                ))}
              </div>
            </div>

            <div class="dropdown">
              <button class="dropdown-toggle">Etiket</button>
              <div class="dropdown-menu">
                {tags.map(tag => (
                  <a href={`/tags/${tag.name}/`} class="dropdown-item">
                    {tag.name} ({tag.count})
                  </a>
                ))}
              </div>
            </div>

            <button id="theme-toggle" class="theme-toggle">
              Aydınlık
            </button>

          </nav>
        </div>
      </header>

      <main class="site-main">
        <slot />
      </main>

      <footer class="site-footer">
        <p>© {new Date().getFullYear()} Ömer</p>
      </footer>
    </div>

    <script>
      const root = document.documentElement;
      const themeBtn = document.getElementById("theme-toggle");
      const dropdowns = document.querySelectorAll(".dropdown");
      const mobileToggle = document.getElementById("mobile-toggle");
      const navMenu = document.getElementById("nav-menu");

      /* THEME */
      if (localStorage.getItem("theme") === "dark") {
        root.classList.add("dark");
        themeBtn.textContent = "Karanlık";
      }

      themeBtn.addEventListener("click", () => {
        root.classList.toggle("dark");

        if (root.classList.contains("dark")) {
          themeBtn.textContent = "Karanlık";
          localStorage.setItem("theme", "dark");
        } else {
          themeBtn.textContent = "Aydınlık";
          localStorage.setItem("theme", "light");
        }
      });

      /* DROPDOWN */
      dropdowns.forEach(dropdown => {
        const toggle = dropdown.querySelector(".dropdown-toggle");

        toggle.addEventListener("click", (e) => {
          e.stopPropagation();

          dropdowns.forEach(d => {
            if (d !== dropdown) d.classList.remove("open");
          });

          dropdown.classList.toggle("open");
        });
      });

      document.addEventListener("click", () => {
        dropdowns.forEach(d => d.classList.remove("open"));
      });

      /* MOBILE MENU */
      mobileToggle.addEventListener("click", (e) => {
        e.stopPropagation();
        navMenu.classList.toggle("open");
      });

      document.addEventListener("click", () => {
        navMenu.classList.remove("open");
      });
    </script>
  </body>
</html>